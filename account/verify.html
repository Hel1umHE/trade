<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èº«ä»½è®¤è¯ - è´¦æˆ·æ¿€æ´»</title>
    <!-- å¼•å…¥æœ¬åœ°Bootstrap CSS -->
    <link rel="stylesheet" href="../res/bootstrap-5.3.8-dist/css/bootstrap.min.css">
</head>

<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white text-center">
                        <h4>èº«ä»½è®¤è¯ - è´¦æˆ·æ¿€æ´»</h4>
                    </div>
                    <div class="card-body" id="app">
                        <div v-if="!userInfo" class="alert alert-warning text-center">
                            æ‚¨è¿˜æœªæ³¨å†Œï¼Œè¯·å…ˆ<a href="register.html" class="alert-link">æ³¨å†Œ</a>
                        </div>
                        <div v-else-if="userInfo.isVerified" class="alert alert-success text-center">
                            <h5>ğŸ‰ æ­å–œæ‚¨ï¼</h5>
                            <p>æ‚¨çš„è´¦æˆ·å·²æˆåŠŸæ¿€æ´»</p>
                            <a href="../index.html" class="btn btn-primary mt-2">è¿”å›é¦–é¡µ</a>
                        </div>
                        <form v-else @submit.prevent="verify" class="mt-4">
                            <div class="text-center mb-4">
                                <h5>æ¬¢è¿ï¼Œ{{ userInfo.nickname }}ï¼</h5>
                                <p class="text-muted">è¯·å®Œæˆèº«ä»½è®¤è¯ä»¥æ¿€æ´»æ‚¨çš„è´¦æˆ·</p>
                            </div>

                            <div class="mb-3">
                                <label for="phone" class="form-label">æ‰‹æœºå·</label>
                                <input type="text" v-model="form.phone" class="form-control" id="phone" readonly
                                    placeholder="æ³¨å†Œæ‰‹æœºå·" required>
                                <div v-if="errors.phone" class="text-danger mt-1 small">{{ errors.phone }}</div>
                            </div>

                            <div class="mb-3">
                                <label for="realName" class="form-label">çœŸå®å§“å</label>
                                <input type="text" v-model="form.realName" class="form-control" id="realName"
                                    placeholder="è¯·è¾“å…¥çœŸå®å§“å" required>
                                <div v-if="errors.realName" class="text-danger mt-1 small">{{ errors.realName }}</div>
                            </div>

                            <div class="mb-3">
                                <label for="className" class="form-label">ç­çº§</label>
                                <input type="text" v-model="form.className" class="form-control" id="className"
                                    placeholder="è¯·è¾“å…¥ç­çº§" required>
                                <div v-if="errors.className" class="text-danger mt-1 small">{{ errors.className }}</div>
                            </div>

                            <div class="mb-3">
                                <label for="studentID" class="form-label">å­¦å·</label>
                                <input type="text" v-model="form.studentID" class="form-control" id="studentID"
                                    placeholder="è¯·è¾“å…¥å­¦å·" required>
                                <div v-if="errors.studentID" class="text-danger mt-1 small">{{ errors.studentID }}</div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100" :disabled="loading">
                                <span v-if="loading" class="spinner-border spinner-border-sm" role="status"
                                    aria-hidden="true"></span>
                                æäº¤è®¤è¯å¹¶æ¿€æ´»è´¦æˆ·
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥æœ¬åœ°Vue.js -->
    <script src="../res/vue.min.js"></script>
    <!-- å¼•å…¥æœ¬åœ°Bootstrap JS -->
    <script src="../res/bootstrap-5.3.8-dist/js/bootstrap.bundle.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                userInfo: null,
                form: {
                    phone: '',
                    realName: '',
                    className: '',
                    studentID: ''
                },
                errors: {},
                loading: false
            },
            mounted() {
                // ä»localStorageè·å–ç”¨æˆ·ä¿¡æ¯
                const storedUser = localStorage.getItem('currentUser') || localStorage.getItem('userInfo');
                if (storedUser) {
                    this.userInfo = JSON.parse(storedUser);
                    // å°†æ³¨å†Œæ‰‹æœºå·å¡«å……åˆ°è¡¨å•ä¸­
                    this.form.phone = this.userInfo.phone;
                }
            },
            methods: {
                validateForm() {
                    this.errors = {};
                    let isValid = true;

                    // éªŒè¯æ‰‹æœºå·
                    if (!this.form.phone) {
                        this.errors.phone = 'æ‰‹æœºå·ä¸èƒ½ä¸ºç©º';
                        isValid = false;
                    } else if (this.form.phone !== this.userInfo.phone) {
                        this.errors.phone = 'æ‰‹æœºå·ä¸æ³¨å†Œä¿¡æ¯ä¸ä¸€è‡´';
                        isValid = false;
                    }

                    // éªŒè¯çœŸå®å§“å
                    if (!this.form.realName) {
                        this.errors.realName = 'çœŸå®å§“åä¸èƒ½ä¸ºç©º';
                        isValid = false;
                    }

                    // éªŒè¯ç­çº§
                    if (!this.form.className) {
                        this.errors.className = 'ç­çº§ä¸èƒ½ä¸ºç©º';
                        isValid = false;
                    }

                    // éªŒè¯å­¦å·
                    if (!this.form.studentID) {
                        this.errors.studentID = 'å­¦å·ä¸èƒ½ä¸ºç©º';
                        isValid = false;
                    }

                    return isValid;
                },
                verify() {
                    if (this.validateForm()) {
                        this.loading = true;

                        // æ¨¡æ‹Ÿèº«ä»½è®¤è¯è¯·æ±‚
                        setTimeout(() => {
                            this.loading = false;
                            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼Œæ ‡è®°ä¸ºå·²è®¤è¯
                            this.userInfo.isVerified = true;
                            // ä¿å­˜è®¤è¯ä¿¡æ¯
                            this.userInfo.realName = this.form.realName;
                            this.userInfo.className = this.form.className;
                            this.userInfo.studentID = this.form.studentID;

                            // æ›´æ–°ç”¨æˆ·åˆ—è¡¨ä¸­çš„ç”¨æˆ·ä¿¡æ¯
                            const users = JSON.parse(localStorage.getItem('users')) || [];
                            const updatedUsers = users.map(user => {
                                if (user.id === this.userInfo.id) {
                                    return this.userInfo;
                                }
                                return user;
                            });
                            localStorage.setItem('users', JSON.stringify(updatedUsers));

                            // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
                            localStorage.setItem('userInfo', JSON.stringify(this.userInfo));
                            localStorage.setItem('currentUser', JSON.stringify(this.userInfo));

                            // æ˜¾ç¤ºæˆåŠŸæç¤º
                            this.$forceUpdate();
                        }, 1500);
                    }
                }
            }
        });
    </script>
</body>

</html>